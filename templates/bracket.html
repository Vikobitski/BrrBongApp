<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bierpong Bracket</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery-bracket@0.11.1/dist/jquery.bracket.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/jquery-bracket@0.11.1/dist/jquery.bracket.min.css" rel="stylesheet">

  <style>
    body{background:#121212;color:#eee;font-family:"Segoe UI",sans-serif;}
    .navbar{background:#1f1f1f;}
    .navbar a{color:#fff!important;}
    h1{text-align:center;margin:1rem 0;}
    #bracket{margin:2rem auto;width:max-content;min-width:600px;padding:1rem;background:#1a1a1a;border-radius:12px;box-shadow:0 0 20px rgba(255,255,255,0.1);}
    .jQBracket .team{background:#292929!important;color:#fff!important;border-radius:6px;border:1px solid #444!important;min-width:120px;}
    .jQBracket .connector{border-color:#00b4ff!important;}
    .jQBracket .round{border-color:#00b4ff!important;}
    .jQBracket .team.winner{background:#157347!important;}
    input.score{width:50px;text-align:center;border-radius:4px;border:1px solid #555;background:#222;color:#fff;margin:0 3px;}
  </style>
</head>
<body>

<nav class="navbar navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">üç∫ Bierpong</a>
    <div><a href="/" class="btn btn-outline-light btn-sm">Home</a></div>
  </div>
</nav>

{% if not_enough %}
  <div class="alert alert-warning text-center mt-4">Not enough teams yet ‚Äì minimum 2 required.</div>
{% else %}
  <h1>Turnierbaum & Ergebnisse</h1>
  <div id="bracket"></div>

  <div class="container mt-5">
    <h4 class="text-center">üèÜ Ergebnisse eintragen</h4>
    <div class="row">
      {% for m in matches %}
        <div class="col-md-6 mb-3">
          <form method="post">
            <div class="card bg-dark border-light">
              <div class="card-body">
                <h5 class="card-title text-info">Match {{ m.id }}</h5>
                <div class="d-flex justify-content-between align-items-center">
                  <span>{{ m.team1 }}</span>
                  <input type="number" name="score1" class="score" value="{{ m.score1 }}">
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <span>{{ m.team2 }}</span>
                  <input type="number" name="score2" class="score" value="{{ m.score2 }}">
                </div>
                <input type="hidden" name="match_id" value="{{ m.id }}">
                <button class="btn btn-sm btn-success mt-3 w-100">üíæ Speichern</button>
              </div>
            </div>
          </form>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<script>
(function(){
  const matchData = {{ matches|tojson|safe }};
  if (!Array.isArray(matchData) || matchData.length === 0) return;

  const teams = [];
  const results = [[]];
  for (const m of matchData) {
    teams.push([m.team1, m.team2]);
    const s1 = parseInt(m.score1);
    const s2 = parseInt(m.score2);
    if (!isNaN(s1) && !isNaN(s2)) results[0].push([s1, s2]);
    else results[0].push([null, null]);
  }

  $('#bracket').bracket({
    init: { teams: teams, results: [results[0]] },
    save: function() {}
  });

  $('#bracket .match').each(function(i){
    const t1 = $(this).find('.team').eq(0);
    const t2 = $(this).find('.team').eq(1);
    const m = matchData[i];
    if (m && m.score1 !== "" && m.score2 !== "") {
      const s1 = parseInt(m.score1);
      const s2 = parseInt(m.score2);
      if (!isNaN(s1) && !isNaN(s2)) {
        if (s1 > s2) t1.addClass('winner');
        else if (s2 > s1) t2.addClass('winner');
      }
    }
  });
})();
</script>
</body>
</html>
